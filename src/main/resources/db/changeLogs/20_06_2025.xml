<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <!-- ChangeSet: Create files table -->
    <changeSet id="1" author="author">
        <createTable tableName="files">
            <column name="upload_time" type="timestamp(6)"/>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="file_path" type="varchar(255)"/>
            <column name="file_type" type="varchar(255)"/>
            <column name="original_name" type="varchar(255)"/>
            <column name="unique_name" type="varchar(255)">
                <constraints unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <!-- ChangeSet: Create brand table -->
    <changeSet id="2" author="author">
        <createTable tableName="brand">
            <column name="created_at" type="timestamp(6)"/>
            <column name="deleted_at" type="timestamp(6)"/>
            <column name="updated_at" type="timestamp(6)"/>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints unique="true" nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- ChangeSet: Create description table -->
    <changeSet id="3" author="author">
        <createTable tableName="description">
            <column name="created_at" type="timestamp(6)"/>
            <column name="deleted_at" type="timestamp(6)"/>
            <column name="updated_at" type="timestamp(6)"/>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="text" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- ChangeSet: Create categories table -->
    <changeSet id="4" author="author">
        <createTable tableName="categories">
            <column name="created_at" type="timestamp(6)"/>
            <column name="deleted_at" type="timestamp(6)"/>
            <column name="updated_at" type="timestamp(6)"/>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- ChangeSet: Create category_image table -->
    <changeSet id="5" author="author">
        <createTable tableName="category_image">
            <column name="category_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="image_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="category_image" baseColumnNames="category_id"
                                 referencedTableName="categories" referencedColumnNames="id"
                                 constraintName="fk_category_image_category"/>
        <addForeignKeyConstraint baseTableName="category_image" baseColumnNames="image_id"
                                 referencedTableName="files" referencedColumnNames="id"
                                 constraintName="fk_category_image_files"/>
    </changeSet>

    <!-- ChangeSet: Create brand_images table -->
    <changeSet id="6" author="author">
        <createTable tableName="brand_images">
            <column name="brand_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="image_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="brand_images" baseColumnNames="brand_id"
                                 referencedTableName="brand" referencedColumnNames="id"
                                 constraintName="fk_brand_images_brand"/>
        <addForeignKeyConstraint baseTableName="brand_images" baseColumnNames="image_id"
                                 referencedTableName="files" referencedColumnNames="id"
                                 constraintName="fk_brand_images_files"/>
    </changeSet>

    <!-- ChangeSet: Create users table -->
    <changeSet id="7" author="author">
        <createTable tableName="users">
            <column name="created_at" type="timestamp(6)"/>
            <column name="updated_at" type="timestamp(6)"/>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="address" type="varchar(255)"/>
            <column name="email" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="password" type="varchar(255)"/>
            <column name="phone_number" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="provider" type="varchar(255)"/>
            <column name="role" type="varchar(255)"/>
        </createTable>
    </changeSet>

    <!-- ChangeSet: Create products table -->
    <changeSet id="8" author="author">
        <createTable tableName="products">
            <column name="discounted_price" type="numeric(15,2)"/>
            <column name="price" type="numeric(15,2)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp(6)"/>
            <column name="deleted_at" type="timestamp(6)"/>
            <column name="updated_at" type="timestamp(6)"/>
            <column name="brand_id" type="uuid"/>
            <column name="category_id" type="uuid"/>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="products" baseColumnNames="brand_id"
                                 referencedTableName="brand" referencedColumnNames="id"
                                 constraintName="fk_products_brand"/>
        <addForeignKeyConstraint baseTableName="products" baseColumnNames="category_id"
                                 referencedTableName="categories" referencedColumnNames="id"
                                 constraintName="fk_products_category"/>
    </changeSet>

    <!-- ChangeSet: Create product_images table -->
    <changeSet id="9" author="aiteginbaratov">
        <createTable tableName="product_images">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="image_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="product_images" baseColumnNames="image_id"
                                 referencedTableName="files" referencedColumnNames="id"
                                 constraintName="fk_product_images_files"/>
        <addForeignKeyConstraint baseTableName="product_images" baseColumnNames="product_id"
                                 referencedTableName="products" referencedColumnNames="id"
                                 constraintName="fk_product_images_products"/>
    </changeSet>

    <!-- ChangeSet: Create product_parameters table -->
    <changeSet id="10" author="aiteginbaratov">
        <createTable tableName="product_parameters">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="product_parameters" baseColumnNames="product_id"
                                 referencedTableName="products" referencedColumnNames="id"
                                 constraintName="fk_product_parameters_products"/>
    </changeSet>

    <!-- ChangeSet: Create product_sub_parameters table -->
    <changeSet id="11" author="aiteginbaratov">
        <createTable tableName="product_sub_parameters">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="product_parameter_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="product_sub_parameters" baseColumnNames="product_parameter_id"
                                 referencedTableName="product_parameters" referencedColumnNames="id"
                                 constraintName="fk_product_sub_parameters_param"/>
    </changeSet>

    <!-- ChangeSet: Create products_descriptions table -->
    <changeSet id="12" author="aiteginbaratov">
        <createTable tableName="products_descriptions">
            <column name="descriptions_id" type="uuid">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="products_descriptions" baseColumnNames="descriptions_id"
                                 referencedTableName="description" referencedColumnNames="id"
                                 constraintName="fk_products_descriptions_desc"/>
        <addForeignKeyConstraint baseTableName="products_descriptions" baseColumnNames="product_id"
                                 referencedTableName="products" referencedColumnNames="id"
                                 constraintName="fk_products_descriptions_prod"/>
    </changeSet>

    <!-- ChangeSet: Create carts and cart_items tables -->
    <changeSet id="13" author="aiteginbaratov">
        <createTable tableName="carts">
            <column name="created_at" type="timestamp(6)"/>
            <column name="updated_at" type="timestamp(6)"/>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="uuid">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="carts" baseColumnNames="user_id"
                                 referencedTableName="users" referencedColumnNames="id"
                                 constraintName="fk_carts_users"/>

        <createTable tableName="cart_items">
            <column name="price" type="numeric(15,2)">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="added_at" type="timestamp(6)">
                <constraints nullable="false"/>
            </column>
            <column name="cart_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="cart_items" baseColumnNames="cart_id"
                                 referencedTableName="carts" referencedColumnNames="id"
                                 constraintName="fk_cart_items_cart"/>
        <addForeignKeyConstraint baseTableName="cart_items" baseColumnNames="product_id"
                                 referencedTableName="products" referencedColumnNames="id"
                                 constraintName="fk_cart_items_product"/>
    </changeSet>

    <!-- ChangeSet: Create favorites and favorite_item tables -->
    <changeSet id="14" author="aiteginbaratov">
        <createTable tableName="favorites">
            <column name="created_at" type="timestamp(6)"/>
            <column name="updated_at" type="timestamp(6)"/>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="uuid">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="favorites" baseColumnNames="user_id"
                                 referencedTableName="users" referencedColumnNames="id"
                                 constraintName="fk_favorites_users"/>

        <createTable tableName="favorite_item">
            <column name="price" type="numeric(15,2)">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="added_at" type="timestamp(6)">
                <constraints nullable="false"/>
            </column>
            <column name="favorite_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="favorite_item" baseColumnNames="favorite_id"
                                 referencedTableName="favorites" referencedColumnNames="id"
                                 constraintName="fk_favorite_item_favorite"/>
        <addForeignKeyConstraint baseTableName="favorite_item" baseColumnNames="product_id"
                                 referencedTableName="products" referencedColumnNames="id"
                                 constraintName="fk_favorite_item_product"/>
    </changeSet>

    <!-- ChangeSet: Create orders and order_items tables -->
    <changeSet id="15" author="aiteginbaratov">
        <createTable tableName="orders">
            <column name="total_price" type="numeric(15,2)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp(6)"/>
            <column name="updated_at" type="timestamp(6)"/>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="address" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="comment" type="text"/>
            <column name="phone_number" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="varchar(255)"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="orders" baseColumnNames="user_id"
                                 referencedTableName="users" referencedColumnNames="id"
                                 constraintName="fk_orders_users"/>

        <createTable tableName="order_items">
            <column name="price" type="numeric(15,2)">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="order_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="order_items" baseColumnNames="order_id"
                                 referencedTableName="orders" referencedColumnNames="id"
                                 constraintName="fk_order_items_order"/>
        <addForeignKeyConstraint baseTableName="order_items" baseColumnNames="product_id"
                                 referencedTableName="products" referencedColumnNames="id"
                                 constraintName="fk_order_items_product"/>
    </changeSet>

    <!-- ChangeSet: Create refresh_tokens table -->
    <changeSet id="16" author="aiteginbaratov">
        <createTable tableName="refresh_tokens">
            <column name="created_at" type="timestamp(6)"/>
            <column name="expiry_date" type="timestamp(6) with time zone">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="uuid"/>
            <column name="token" type="text">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="refresh_tokens" baseColumnNames="user_id"
                                 referencedTableName="users" referencedColumnNames="id"
                                 constraintName="fk_refresh_tokens_user"/>
    </changeSet>

<!--    <changeSet id="Admin" author="JekiChan08">-->
<!--        <loadData tableName="users" file="data/users.csv" relativeToChangelogFile="true" separator=";"/>-->
<!--    </changeSet>-->

    <changeSet id="update-products-name-index" author="JekiChan08">
        <sql splitStatements="true" stripComments="true">
            CREATE EXTENSION IF NOT EXISTS pg_trgm;
            CREATE INDEX IF NOT EXISTS idx_products_name_trgm ON products USING gin (name gin_trgm_ops);
        </sql>
    </changeSet>

</databaseChangeLog>
